<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Create New Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/admin_style.css" />
    <style>
        .add-item-form {
          border: 1px solid var(--border-color);
        }
        #order-items-table .remove-item-btn {
          opacity: 0.6;
          transition: opacity 0.2s ease;
        }
        #order-items-table tr:hover .remove-item-btn {
          opacity: 1;
        }
        .order-totals {
          width: 100%;
          max-width: 400px;
          margin-left: auto;
          font-size: 1rem;
        }
        .order-totals .h4 {
          font-size: 1.25rem;
        }
        /* Style untuk Modal Pembayaran */
        .payment-modal-body {
            font-family: 'Inter', sans-serif;
        }
        .va-number {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--primary);
            background-color: var(--primary-light);
            padding: 0.75rem;
            border-radius: var(--border-radius);
            display: inline-block;
        }
        .qr-code {
            width: 220px;
            height: 220px;
            border: 5px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 5px;
        }
        .copy-btn {
            border: none;
            background: none;
            color: var(--text-secondary);
        }
        /* Style untuk Bukti Pembayaran */
        #proof-section {
            font-family: 'Courier New', Courier, monospace;
            border: 2px dashed #333;
            padding: 1.5rem;
        }
        #proof-section hr {
            border-top: 2px dashed #333;
        }
        @media (max-width: 768px) {
          .add-item-form .row > div {
            flex-basis: 100%;
            width: 100%;
          }
          .add-item-form .btn {
            margin-top: 0.5rem;
          }
        }
        @media print {
            body * { visibility: hidden; }
            #proof-section, #proof-section * { visibility: visible; }
            #proof-section { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                border: none;
            }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="admin-wrapper">
        <div id="sidebar-container"></div>
        <div id="overlay"></div>

        <div class="main-content" id="mainContent">
            <header class="content-header">
                <div class="header-welcome">
                    <h2 class="mb-0">Create New Order</h2>
                    <p class="text-muted">Manually add a new order to the system.</p>
                </div>
            </header>

            <section class="content-section">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <form id="create-order-form">
                            <div class="row g-4">
                                <div class="col-lg-4">
                                    <h5 class="card-title-custom mb-3">Customer Details</h5>
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">Customer Name</label>
                                        <input type="text" class="form-control" id="customerName" placeholder="Contoh: Revan Putra" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="orderDate" class="form-label">Order Date</label>
                                        <input type="date" class="form-control" id="orderDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="orderStatus" class="form-label">Status</label>
                                        <select class="form-select" id="orderStatus" required>
                                            <option value="Pending" selected>Pending</option>
                                            <option value="Completed">Completed</option>
                                            <option value="delivery">Delivery</option>
                                            <option value="Canceled">Canceled</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <h5 class="card-title-custom mb-3">Metode pembayaran</h5>
                                        <label for="paymentBank" class="form-label">Bank</label>
                                        <select class="form-select" id="paymentBank">
                                            <option value="none" selected>Pilih Bank...</option>
                                            <option value="BCA">BCA</option>
                                            <option value="BRI">BRI</option>
                                            <option value="Mandiri">Mandiri</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="paymentEwallet" class="form-label">E-wallet</label>
                                        <select class="form-select" id="paymentEwallet">
                                            <option value="none" selected>Pilih E-Wallet...</option>
                                            <option value="Qris">Qris</option>
                                            <option value="Gopay">Gopay</option>
                                            <option value="ShopeePay">ShopeePay</option>
                                        </select>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="COD" id="paymentCOD">
                                        <label class="form-check-label" for="paymentCOD">
                                            Cash / Tunai
                                        </label>
                                    </div>
                                </div>

                                <div class="col-lg-8">
                                    <h5 class="card-title-custom mb-3">Order Items</h5>
                                    
                                    <div class="add-item-form bg-light p-3 rounded mb-3">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-sm-6">
                                                <label for="product-select" class="form-label small">Select Product</label>
                                                <select class="form-select" id="product-select"></select>
                                            </div>
                                            <div class="col-sm-3">
                                                <label for="product-quantity" class="form-label small">Quantity</label>
                                                <input type="number" class="form-control" id="product-quantity" value="1" min="1">
                                            </div>
                                            <div class="col-sm-3">
                                                <button type="button" class="btn btn-primary-custom w-100" id="add-product-btn">
                                                    <i class="fas fa-plus me-1"></i> Add
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th class="text-center">Qty</th>
                                                    <th class="text-end">Subtotal</th>
                                                    <th class="text-end"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="order-items-table">
                                                <tr id="no-items-row">
                                                    <td colspan="4" class="text-center text-muted py-4">Belum ada produk yang ditambahkan.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <hr>

                                    <div class="order-totals">
                                        <div class="d-flex justify-content-end mb-2">
                                            <span class="text-muted me-4">Subtotal:</span>
                                            <span class="fw-bold" id="subtotal-amount">Rp 0</span>
                                        </div>
                                        <div class="d-flex justify-content-end mb-2">
                                            <span class="text-muted me-4">Shipping:</span>
                                            <span class="fw-bold ">Rp 15.000</span> </div>
                                        <div class="d-flex justify-content-end h4">
                                            <span class="text-muted me-4">Total:</span>
                                            <span class="fw-bold text-success" id="total-amount">Rp 15.000</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex justify-content-end gap-2">
                                <a href="orders.html" class="btn btn-outline-danger">Cancel</a>
                                <button type="submit" class="btn btn-success" id="save-order-btn">
                                    <i class="fas fa-money-check-alt me-1"></i> Simpan Pesanan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <footer class="footer mt-auto py-3"></footer>
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detail Pembayaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body payment-modal-body text-center">
                    <div id="bank-transfer-content" class="d-none">
                        <h5 id="bank-name-title" class="mb-3"></h5>
                        <p class="text-muted">Selesaikan pembayaran ke Virtual Account berikut:</p>
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <span id="va-number" class="va-number"></span>
                            <button class="copy-btn ms-2" id="copy-va-btn" title="Salin Nomor VA"><i class="far fa-copy fa-lg"></i></button>
                        </div>
                        <p class="fw-bold">Total Pembayaran: <span id="total-payment-bank" class="text-success"></span></p>
                    </div>
                    
                    <div id="ewallet-content" class="d-none">
                         <h5 id="ewallet-name-title" class="mb-3"></h5>
                         <p class="text-muted">Scan QR Code di bawah ini untuk membayar:</p>
                         <img id="qr-code-img" src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https://smartfarm.com/pay/ORDER123" alt="QR Code" class="qr-code mb-3">
                         <p class="fw-bold">Total Pembayaran: <span id="total-payment-ewallet" class="text-success"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary-custom" id="mark-as-paid-btn">Tandai sebagai Lunas</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="proofModal" tabindex="-1" aria-labelledby="proofModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header no-print">
                    <h5 class="modal-title" id="proofModalLabel">Bukti Pembayaran Lunas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="proof-section">
                        <div class="text-center mb-4">
                            <h4>** BUKTI PEMBAYARAN **</h4>
                            <h5>SMARTFARM STORE</h5>
                            <p class="mb-0">Jl. Kebun Raya No. 123, Sidoarjo</p>
                        </div>
                        <hr>
                        <div id="proof-details"></div>
                        <hr>
                        <div id="proof-items"></div>
                        <hr>
                        <div id="proof-totals"></div>
                        <hr>
                        <div class="text-center mt-4">
                            <p class="fw-bold mb-0">TERIMA KASIH</p>
                            <p>Telah Berbelanja di SmartFarm</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-outline-danger" id="close-proof-btn">Tutup</button>
                    <button type="button" class="btn btn-primary-custom" onclick="window.print();"><i class="fas fa-print me-2"></i>Cetak</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../assets/js/admin_script.js"></script>

    <script>
    function getSampleProducts() {
        return [
            { id: 1, name: "HydroKit Mini Starter", price: 185000 }, { id: 7, name: "HydroTower Vertical Garden", price: 750000 }, { id: 8, name: "Dutch Bucket System (5 Pot)", price: 450000 }, { id: 15, name: "Window Farm Kit", price: 250000 }, { id: 2, name: "Caladium Red Star", price: 75000 }, { id: 6, name: "Monstera Deliciosa", price: 125000 }, { id: 9, name: "Sansevieria Trifasciata", price: 60000 }, { id: 10, name: "Alocasia Black Velvet", price: 150000 }, { id: 3, name: "Bibit Selada Romaine (Hydro)", price: 25000 }, { id: 11, name: "Benih Kangkung Bangkok", price: 12000 }, { id: 12, name: "Benih Tomat Cherry Super", price: 30000 }, { id: 18, name: "Bibit Strawberry California", price: 45000 }, { id: 4, name: "Nutrisi AB Mix Premium", price: 45000 }, { id: 13, name: "Pupuk Organik Cair (POC)", price: 35000 }, { id: 14, name: "Root Booster Super", price: 55000 }, { id: 20, name: "Kalsium Nitrat (KNO3)", price: 28000 }, { id: 5, name: "Rockwool Cultilene", price: 15000 }, { id: 16, name: "Hydroton Jerman", price: 35000 }, { id: 17, name: "Cocopeat Blok Premium", price: 22000 }, { id: 19, name: "Sekam Bakar Fermentasi", price: 18000 }
        ];
    }

    document.addEventListener("DOMContentLoaded", function () {
        const allProducts = getSampleProducts();
        const productSelect = document.getElementById('product-select');
        const addProductBtn = document.getElementById('add-product-btn');
        const orderItemsTable = document.getElementById('order-items-table');
        const noItemsRow = document.getElementById('no-items-row');
        const saveOrderBtn = document.getElementById('save-order-btn');
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const proofModal = new bootstrap.Modal(document.getElementById('proofModal'));
        
        let currentOrderItems = [];

        productSelect.innerHTML = '<option selected disabled>Pilih sebuah produk...</option>';
        allProducts.forEach(p => {
            productSelect.innerHTML += `<option value="${p.id}">${p.name} - Rp ${p.price.toLocaleString('id-ID')}</option>`;
        });
        
        document.getElementById('orderDate').valueAsDate = new Date();

        function renderOrderItems() {
            if (currentOrderItems.length === 0) {
                noItemsRow.style.display = 'table-row';
                orderItemsTable.innerHTML = '';
                orderItemsTable.appendChild(noItemsRow);
            } else {
                noItemsRow.style.display = 'none';
                orderItemsTable.innerHTML = '';
                currentOrderItems.forEach((item, index) => {
                    const subtotal = item.price * item.quantity;
                    const row = `
                        <tr>
                            <td>
                                <div class="fw-bold">${item.name}</div>
                                <small class="text-muted">@ Rp ${item.price.toLocaleString('id-ID')}</small>
                            </td>
                            <td class="text-center" style="width: 80px;">${item.quantity}</td>
                            <td class="text-end fw-bold" style="width: 150px;">Rp ${subtotal.toLocaleString('id-ID')}</td>
                            <td class="text-end" style="width: 50px;">
                                <button type="button" class="btn btn-icon btn-sm text-danger remove-item-btn" data-index="${index}" title="Hapus item">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    orderItemsTable.innerHTML += row;
                });
            }
            updateTotals();
        }

        function updateTotals() {
            const subtotal = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = 15000;
            const total = subtotal + shipping;
            document.getElementById('subtotal-amount').textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
            document.getElementById('total-amount').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }

        addProductBtn.addEventListener('click', function() {
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(document.getElementById('product-quantity').value);
            if (isNaN(productId) || isNaN(quantity) || quantity < 1) {
                Swal.fire('Oops!', 'Pilih produk dan tentukan jumlahnya dulu ya.', 'warning');
                return;
            }
            const product = allProducts.find(p => p.id === productId);
            const existingItem = currentOrderItems.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentOrderItems.push({ id: product.id, name: product.name, price: product.price, quantity: quantity });
            }
            renderOrderItems();
        });
        
        orderItemsTable.addEventListener('click', function(e) {
            const removeBtn = e.target.closest('.remove-item-btn');
            if(removeBtn) {
                const indexToRemove = parseInt(removeBtn.dataset.index);
                currentOrderItems.splice(indexToRemove, 1);
                renderOrderItems();
            }
        });

        saveOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentOrderItems.length === 0) {
                Swal.fire('Gagal!', 'Order harus punya minimal 1 produk.', 'error');
                return;
            }

            const selectedBank = document.getElementById('paymentBank').value;
            const selectedEwallet = document.getElementById('paymentEwallet').value;
            const isCOD = document.getElementById('paymentCOD').checked;

            if (selectedBank === 'none' && selectedEwallet === 'none' && !isCOD) {
                Swal.fire('Gagal!', 'Pilih salah satu metode pembayaran (Bank, E-wallet, atau COD).', 'error');
                return;
            }
            
            if (isCOD) {
                 Swal.fire({
                    title: 'Order COD Dibuat!',
                    text: 'Order baru dengan metode COD berhasil dibuat.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'orders.html';
                });
                return;
            }

            preparePaymentModal(selectedBank, selectedEwallet);
            paymentModal.show();
        });

        function preparePaymentModal(bank, ewallet) {
            const totalAmountText = document.getElementById('total-amount').textContent;
            const bankContent = document.getElementById('bank-transfer-content');
            const ewalletContent = document.getElementById('ewallet-content');

            bankContent.classList.add('d-none');
            ewalletContent.classList.add('d-none');

            if (bank !== 'none') {
                document.getElementById('bank-name-title').textContent = `Bank ${bank.toUpperCase()}`;
                document.getElementById('va-number').textContent = '8808' + Math.floor(1000000000 + Math.random() * 9000000000);
                document.getElementById('total-payment-bank').textContent = totalAmountText;
                bankContent.classList.remove('d-none');
            } else if (ewallet !== 'none') {
                document.getElementById('ewallet-name-title').textContent = ewallet;
                const qrData = `smartfarm://pay?order_id=SF12345&amount=${totalAmountText.replace(/[^0-9]/g, '')}&method=${ewallet}`;
                document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(qrData)}`;
                document.getElementById('total-payment-ewallet').textContent = totalAmountText;
                ewalletContent.classList.remove('d-none');
            }
        }

        document.getElementById('copy-va-btn').addEventListener('click', function() {
            const vaNumber = document.getElementById('va-number').textContent;
            navigator.clipboard.writeText(vaNumber).then(() => {
                Swal.fire({ title: 'Tersalin!', text: 'Nomor Virtual Account berhasil disalin.', icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            });
        });

        document.getElementById('mark-as-paid-btn').addEventListener('click', function() {
            paymentModal.hide();
            
            // Siapkan dan tampilkan modal bukti pembayaran
            prepareProofModal();
            proofModal.show();
        });

        function prepareProofModal() {
            const customerName = document.getElementById('customerName').value;
            const now = new Date();
            const orderId = `SF-${now.getTime()}`;
            
            // Isi detail dasar
            let detailsHtml = `
                <div class="d-flex justify-content-between"><p>ID Pesanan:</p><p>${orderId}</p></div>
                <div class="d-flex justify-content-between"><p>Tanggal:</p><p>${now.toLocaleDateString('id-ID')}, ${now.toLocaleTimeString('id-ID')}</p></div>
                <div class="d-flex justify-content-between"><p>Customer:</p><p>${customerName}</p></div>
                <div class="d-flex justify-content-between"><p>Status:</p><p class="fw-bold">LUNAS</p></div>
            `;
            document.getElementById('proof-details').innerHTML = detailsHtml;

            // Isi item
            let itemsHtml = '';
            currentOrderItems.forEach(item => {
                itemsHtml += `
                <div class="d-flex justify-content-between">
                    <p>${item.name} (x${item.quantity})</p>
                    <p>Rp${(item.price * item.quantity).toLocaleString('id-ID')}</p>
                </div>
                `;
            });
            document.getElementById('proof-items').innerHTML = itemsHtml;

            // Isi Total
            const subtotalText = document.getElementById('subtotal-amount').textContent;
            const totalText = document.getElementById('total-amount').textContent;
            let totalsHtml = `
                <div class="d-flex justify-content-between"><p>Subtotal:</p><p>${subtotalText}</p></div>
                <div class="d-flex justify-content-between"><p>Pengiriman:</p><p>Rp 15.000</p></div>
                <div class="d-flex justify-content-between fw-bold h5"><p>TOTAL:</p><p>${totalText}</p></div>
            `;
            document.getElementById('proof-totals').innerHTML = totalsHtml;
        }

        document.getElementById('close-proof-btn').addEventListener('click', function() {
            proofModal.hide();
            // Arahkan ke halaman daftar pesanan setelah bukti pembayaran ditutup
            window.location.href = 'orders.html';
        });

    });
    </script>
</body>
</html>